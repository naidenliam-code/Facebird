<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FaceBird üê¶ - Fil d‚Äôactualit√©</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.webmanifest"><meta name="theme-color" content="#1e73e8">
  <link rel="apple-touch-icon" href="icon-192.png"><link rel="icon" href="favicon.svg" type="image/svg+xml">
  <meta name="description" content="Fil d‚Äôactualit√© FaceBird : posts + observations avec photos, likes, commentaires et partage.">
  <style>
    .composer { display:grid; gap:10px; grid-template-columns: 1fr; }
    .composer .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .preview { margin-top:6px }
    .preview img { max-width:180px; border-radius:10px }

    .post{display:flex;gap:12px}
    .avatar{width:42px;height:42px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;background:var(--card-bg-weak,#eef3ff)}
    .post-body{flex:1}
    .post-head{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .post-actions{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
    .icon-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;background:var(--chip-bg,#eef2f7);cursor:pointer;border:none}
    .icon-btn[aria-pressed="true"]{background:#ffdfe3}
    .comments{margin-top:8px;border-top:1px solid var(--hair,#e5e7eb);padding-top:8px}
    .comment{margin:6px 0;font-size:.95rem}
    .comment small{color:#667085}
    .comment-form{display:flex;gap:8px;margin-top:6px}
    .comment-form input{flex:1}
    .empty{color:#667085;text-align:center;padding:20px 10px}
    .post-photo{margin-top:8px;border-radius:12px;overflow:hidden}
    .post-photo img{width:100%;height:auto;display:block}

    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:9999}
    .lightbox.open{display:flex}
    .lightbox img{max-width:92vw;max-height:92vh;border-radius:12px}
    .lightbox .close{position:absolute;top:12px;right:12px;background:#fff;border:none;border-radius:10px;padding:8px 10px;cursor:pointer}
  </style>
</head>
<body>
  <header><h1>üì∞ Fil d‚Äôactualit√©</h1><p>Publie des posts et vois les derni√®res observations</p></header>

  <!-- NAV commune -->
  <nav id="site-nav"></nav>

  <main class="container">
    <!-- üé§ √âDITEUR DE POST -->
    <div class="card">
      <h2>‚ûï Nouveau post</h2>
      <form id="composer" class="composer">
        <textarea id="post-text" rows="3" maxlength="500" placeholder="Partage une pens√©e, une astuce d‚Äôobservation, une actu‚Ä¶"></textarea>
        <div class="row">
          <label class="btn btn-small" for="post-photo">üì∑ Ajouter une photo</label>
          <input id="post-photo" type="file" accept="image/*" capture="environment" style="display:none">
          <button class="btn" type="submit">Publier</button>
        </div>
        <div id="post-preview" class="preview"></div>
        <small class="muted">Conseil : √©vite les infos perso. Les posts sont stock√©s sur ton appareil (hors-ligne OK).</small>
      </form>
    </div>

    <!-- üßµ FLUX MIXTE -->
    <div id="feed" class="grid"></div>
  </main>

  <footer>Cr√©√© par <b>Liam üëë</b></footer>

  <!-- Lightbox -->
  <div id="lb" class="lightbox" aria-hidden="true">
    <button class="close" aria-label="Fermer">‚úï</button>
    <img id="lb-img" alt="Image">
  </div>

  <!-- Scripts -->
  <script src="nav.js" defer></script>
  <script src="theme.js" defer></script>
  <script src="badges.js" defer></script>
  <script src="points.js" defer></script>

  <script>
  (function(){
    const USERNAME = 'Liam';
    const OBS_KEY = 'fb-observations-v1'; // existant
    const POST_KEY = 'fb-posts-v1';       // NOUVEAU : posts du fil
    const $ = (s, r=document) => r.querySelector(s);
    const esc = (str='') => String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));

    const load = (k) => { try { return JSON.parse(localStorage.getItem(k)||'[]'); } catch { return []; } };
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    // --------- COMPOSER (post texte + photo)
    let draftPhoto = null;
    const composer = $('#composer');
    const photoInput = $('#post-photo');
    const preview = $('#post-preview');
    photoInput.addEventListener('change', () => {
      const f = photoInput.files[0];
      if (!f) { draftPhoto = null; preview.innerHTML = ''; return; }
      const r = new FileReader();
      r.onload = e => {
        draftPhoto = e.target.result;
        preview.innerHTML = `<img src="${draftPhoto}" alt="aper√ßu">`;
      };
      r.readAsDataURL(f);
    });

    composer.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = ($('#post-text').value || '').trim();
      if (!text && !draftPhoto) { alert('√âcris quelque chose ou ajoute une photo.'); return; }

      const posts = load(POST_KEY);
      posts.unshift({
        type: 'post',
        id: 'p' + Date.now() + Math.random().toString(36).slice(2,6),
        ts: Date.now(),
        author: USERNAME,
        text,
        photo: draftPhoto || null,
        likes: 0,
        comments: []
      });
      save(POST_KEY, posts);

      // reset
      $('#post-text').value = '';
      photoInput.value = '';
      preview.innerHTML = '';
      draftPhoto = null;

      FB_POINTS?.add('post'); // petit bonus
      renderFeed();
    });

    // --------- Rendu du feed mixte (posts + observations)
    function normalizeObs(list){
      let changed = false;
      list.forEach(o => {
        if (!o.id) { o.id = 'o' + (o.ts || Date.now()) + Math.random().toString(36).slice(2,5); changed = true; }
        if (typeof o.likes !== 'number') { o.likes = 0; changed = true; }
        if (!Array.isArray(o.comments)) { o.comments = []; changed = true; }
      });
      if (changed) save(OBS_KEY, list);
      return list.map(o => ({ ...o, type: 'observation' })); // tag de type
    }

    function normalizePosts(list){
      let changed = false;
      list.forEach(p => {
        if (!p.id) { p.id = 'p' + (p.ts || Date.now()) + Math.random().toString(36).slice(2,5); changed = true; }
        if (typeof p.likes !== 'number') { p.likes = 0; changed = true; }
        if (!Array.isArray(p.comments)) { p.comments = []; changed = true; }
      });
      if (changed) save(POST_KEY, list);
      return list;
    }

    function speciesIcon(espece=''){ const s=espece.toLowerCase();
      if (s.includes('hibou')||s.includes('chouette')) return 'ü¶â';
      if (s.includes('pigeon')) return 'üïäÔ∏è';
      if (s.includes('m√©sange')||s.includes('mesange')) return 'üê¶';
      return 'üê¶';
    }

    function renderFeed(){
      const feedEl = $('#feed');
      const obs = normalizeObs(load(OBS_KEY));
      const posts = normalizePosts(load(POST_KEY));
      const items = [...posts, ...obs].sort((a,b) => (b.ts||0)-(a.ts||0));

      if (!items.length){
        feedEl.innerHTML = `<div class="card empty">Rien pour le moment. √âcris un post ou ajoute une observation !</div>`;
        return;
      }

      feedEl.innerHTML = '';
      items.forEach(it => feedEl.appendChild(renderItem(it)));
      bindLightbox();
    }

    function renderItem(it){
      const card = document.createElement('div'); card.className = 'card';
      const pts = FB_POINTS?.load() || 0;
      const avatarUrl = FB_POINTS?.getAvatarUrl?.(pts) || 'avatar-debutant-256.png';

      if (it.type === 'post') {
        card.innerHTML = `
          <div class="post">
            <div class="avatar"><img src="${avatarUrl}" alt="avatar" style="width:100%;height:100%;object-fit:cover"></div>
            <div class="post-body">
              <div class="post-head">
                <strong>${esc(it.author || 'Utilisateur')}</strong>
                <span class="badge">Post</span>
                <small class="muted">‚Ä¢ ${new Date(it.ts).toLocaleString()}</small>
              </div>
              ${it.photo ? `<div class="post-photo"><img src="${it.photo}" alt="photo" class="zoomable"></div>` : ''}
              ${it.text ? `<p style="margin:.4rem 0 0; white-space:pre-wrap">${esc(it.text)}</p>` : ''}
              ${renderActions(it)}
              ${renderComments(it)}
            </div>
          </div>`;
      } else { // observation
        const hasGPS = typeof it.lat === 'number' && typeof it.lng === 'number';
        card.innerHTML = `
          <div class="post">
            <div class="avatar"><img src="${avatarUrl}" alt="avatar" style="width:100%;height:100%;object-fit:cover"></div>
            <div class="post-body">
              <div class="post-head">
                <strong>${speciesIcon(it.espece)} ${esc(it.espece || 'Observation')}</strong>
                ${it.lieu ? `<span class="badge">${esc(it.lieu)}</span>` : ''}
                ${hasGPS ? `<span class="badge">GPS ‚úî</span>` : ''}
                <small class="muted">‚Ä¢ ${esc(it.date || '')}</small>
              </div>
              ${it.photo ? `<div class="post-photo"><img src="${it.photo}" alt="photo observation" class="zoomable"></div>` : ''}
              <p style="margin:.4rem 0 0">${esc(it.desc || '‚Äî')}</p>
              ${renderActions(it, hasGPS)}
              ${renderComments(it)}
            </div>
          </div>`;
      }

      // bind actions
      const likeBtn = card.querySelector('.like-btn');
      likeBtn.addEventListener('click', () => toggleLike(it, likeBtn));

      const toggle = card.querySelector('.cmt-toggle');
      const cwrap = card.querySelector('.comments');
      toggle.addEventListener('click', () => {
        cwrap.hidden = !cwrap.hidden;
        if (!cwrap.hidden) cwrap.querySelector('input')?.focus();
      });

      const form = card.querySelector('.comment-form');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = form.querySelector('input');
        const txt = input.value.trim();
        if (!txt) return;
        addComment(it, { author: USERNAME, text: txt, when: new Date().toLocaleString() });
        const lst = cwrap.querySelector('.cmt-list');
        const div = document.createElement('div'); div.className = 'comment';
        div.innerHTML = `<b>${esc(USERNAME)}</b> <small>${esc(new Date().toLocaleString())}</small><br>${esc(txt)}`;
        lst.appendChild(div);
        input.value = '';
        FB_POINTS?.add('comment');
      });

      const shareBtn = card.querySelector('.share-btn');
      shareBtn.addEventListener('click', () => shareItem(it));

      return card;
    }

    function renderActions(it, hasGPS=false){
      return `
        <div class="post-actions">
          <button class="icon-btn like-btn" aria-pressed="false" data-id="${it.id}">‚ù§Ô∏è <span class="lk">${it.likes||0}</span></button>
          <button class="icon-btn cmt-toggle" data-id="${it.id}">üí¨ Commenter</button>
          <button class="icon-btn share-btn" data-id="${it.id}">üì§ Partager</button>
          ${it.type==='observation' && hasGPS ? `<a class="icon-btn" href="map.html" title="Voir sur la carte">üó∫Ô∏è Carte</a>` : ''}
        </div>`;
    }

    function renderComments(it){
      return `
        <div class="comments" data-id="${it.id}" hidden>
          <div class="cmt-list">
            ${(it.comments||[]).map(c => `<div class="comment"><b>${esc(c.author)}</b> <small>${esc(c.when)}</small><br>${esc(c.text)}</div>`).join('')}
          </div>
          <form class="comment-form" data-id="${it.id}">
            <input type="text" required maxlength="280" placeholder="Ajouter un commentaire‚Ä¶">
            <button class="btn" type="submit">Envoyer</button>
          </form>
        </div>`;
    }

    // ------- interactions
    function storeBack(it, updated){
      if (it.type === 'post') {
        const list = load(POST_KEY);
        const i = list.findIndex(x => x.id === it.id);
        if (i >= 0) { list[i] = updated; save(POST_KEY, list); }
      } else {
        const list = load(OBS_KEY);
        const i = list.findIndex(x => x.id === it.id);
        if (i >= 0) { list[i] = updated; save(OBS_KEY, list); }
      }
    }

    function toggleLike(it, btn){
      const LKEY = 'fb-liked-' + it.id;
      const liked = localStorage.getItem(LKEY) === '1';
      const curLikes = Number(it.likes||0);
      const nextLikes = liked ? Math.max(0, curLikes - 1) : curLikes + 1;
      const updated = { ...it, likes: nextLikes };
      storeBack(it, updated);

      btn.querySelector('.lk').textContent = nextLikes;
      btn.setAttribute('aria-pressed', liked ? 'false' : 'true');
      if (liked) localStorage.removeItem(LKEY); else localStorage.setItem(LKEY, '1');
      if (!liked) FB_POINTS?.add('like', { onceId: it.id });
    }

    function addComment(it, cmt){
      const updated = { ...it, comments: [...(it.comments||[]), cmt] };
      storeBack(it, updated);
    }

    function shareItem(it){
      const text = it.type==='post'
        ? (it.text || 'Post FaceBird')
        : `üê¶ ${it.espece || 'Observation'}${it.lieu ? ' ‚Ä¢ '+it.lieu : ''} ‚Äî ${it.desc || ''}`;
      const url = location.origin + location.pathname.replace(/feed\.html$/, 'index.html');
      const done = () => FB_POINTS?.add('share');

      if (navigator.share) {
        navigator.share({ title: 'FaceBird', text, url }).then(done).catch(()=>{});
      } else {
        navigator.clipboard?.writeText(`${text}\n${url}`).then(()=>{ toast('Lien copi√© üìã'); done(); });
      }
    }

    function toast(msg){
      const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
      document.body.appendChild(t); setTimeout(()=>t.remove(),2000);
    }

    // ------- lightbox
    function bindLightbox(){
      const lb = document.getElementById('lb');
      const lbImg = document.getElementById('lb-img');
      const closeBtn = lb.querySelector('.close');
      document.querySelectorAll('.zoomable').forEach(img=>{
        img.addEventListener('click', ()=>{
          lbImg.src = img.src;
          lb.classList.add('open'); lb.setAttribute('aria-hidden', 'false');
        });
      });
      const close = ()=>{ lb.classList.remove('open'); lb.setAttribute('aria-hidden','true'); lbImg.src=''; };
      closeBtn.addEventListener('click', close);
      lb.addEventListener('click', e=>{ if (e.target===lb) close(); });
      window.addEventListener('keydown', e=>{ if (e.key==='Escape') close(); });
    }

    document.addEventListener('DOMContentLoaded', renderFeed);
  })();
  </script>

  <script src="sw-register.js" defer></script>
  <script src="install-check.js" defer></script><script>
if ('serviceWorker' in navigator) {
  var base=(location.pathname.split('/').slice(0,-1).join('/')+'/').replace(/\/+$/,'/')||'/';
  navigator.serviceWorker.register(base+'service-worker.js',{scope:base}).catch(()=>{});
}
</script>
</body>
</html>
